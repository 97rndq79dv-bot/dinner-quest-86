<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DINNER QUEST '86 - Find Your Date!</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --neon-pink: #ff2d95;
    --neon-cyan: #00e5ff;
    --neon-yellow: #ffe600;
    --neon-green: #39ff14;
    --neon-purple: #b026ff;
    --neon-orange: #ff6600;
    --dark-bg: #0a0a1a;
    --grid-line: #1a1a3a;
  }

  body {
    font-family: 'Press Start 2P', monospace;
    background: var(--dark-bg);
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
    image-rendering: pixelated;
  }

  /* Scanlines */
  body::after {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.12) 2px, rgba(0,0,0,0.12) 4px);
    pointer-events: none;
    z-index: 9999;
  }

  .stars { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; overflow: hidden; }
  .star { position: absolute; width: 2px; height: 2px; background: #fff; animation: twinkle 2s infinite alternate; }
  @keyframes twinkle { 0% { opacity: 0.2; } 100% { opacity: 1; } }

  .container { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; padding: 16px; }

  /* HEADER */
  .header { text-align: center; padding: 20px 0 12px; }
  .title-row {
    position: relative;
    display: inline-block;
    line-height: 1.6;
    overflow: visible;
  }
  .title-letter {
    font-family: 'Press Start 2P', monospace;
    font-size: 24px;
    background: linear-gradient(180deg, var(--neon-yellow) 0%, var(--neon-orange) 50%, var(--neon-pink) 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    display: inline-block;
    transition: opacity 0.12s ease-out, transform 0.12s ease-out;
    filter: drop-shadow(0 0 10px rgba(255,45,149,0.5));
  }
  .title-letter.eaten {
    opacity: 0;
    transform: scale(0.3);
  }
  .title-letter.space { width: 14px; }

  /* PAC-MAN */
  .pacman-container {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: -40px;
    width: 30px;
    height: 30px;
    z-index: 10;
    pointer-events: none;
    filter: drop-shadow(0 0 8px rgba(255,230,0,0.6));
  }
  .pacman-body {
    width: 30px;
    height: 30px;
    position: relative;
  }
  .pac-top, .pac-bottom {
    position: absolute;
    width: 30px;
    height: 15px;
    background: var(--neon-yellow);
    left: 0;
  }
  .pac-top {
    top: 0;
    border-radius: 15px 15px 0 0;
    animation: chomptop 0.25s steps(2) infinite;
    transform-origin: bottom center;
  }
  .pac-bottom {
    bottom: 0;
    border-radius: 0 0 15px 15px;
    animation: chompbottom 0.25s steps(2) infinite;
    transform-origin: top center;
  }
  .pac-eye {
    position: absolute;
    width: 5px; height: 5px;
    background: var(--dark-bg);
    border-radius: 0;
    top: 4px; right: 6px;
    z-index: 2;
  }
  @keyframes chomptop { 0% { transform: rotate(0deg); } 50% { transform: rotate(-18deg); } 100% { transform: rotate(0deg); } }
  @keyframes chompbottom { 0% { transform: rotate(0deg); } 50% { transform: rotate(18deg); } 100% { transform: rotate(0deg); } }

  /* DOT TRAIL */
  .pac-dots {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    transform: translateY(-50%);
    pointer-events: none;
    height: 6px;
    z-index: 5;
  }
  .pac-dot {
    position: absolute;
    width: 4px; height: 4px;
    background: #ffcc00;
    border-radius: 0;
    top: 1px;
    transition: opacity 0.1s;
  }
  .pac-dot.eaten { opacity: 0; }

  .subtitle { font-size: 9px; color: var(--neon-cyan); margin-top: 6px; text-shadow: 0 0 10px var(--neon-cyan); animation: blink 1.5s step-end infinite; }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* PIXEL BOX */
  .pixel-box {
    border: 4px solid var(--neon-cyan);
    background: rgba(0,0,0,0.6);
    padding: 20px;
    margin: 12px 0;
    position: relative;
    box-shadow: 0 0 10px var(--neon-cyan), inset 0 0 10px rgba(0,229,255,0.1);
  }
  .pixel-box::before {
    content: ''; position: absolute;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    border: 2px solid var(--neon-pink); pointer-events: none; opacity: 0.5;
  }
  .pixel-box h2 { font-size: 13px; color: var(--neon-yellow); margin-bottom: 14px; text-shadow: 0 0 8px var(--neon-yellow); text-align: center; }

  /* CHARACTER SELECT */
  .char-select { display: flex; gap: 14px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
  .char-card {
    display: flex; flex-direction: column; align-items: center; gap: 8px;
    padding: 16px 20px; border: 3px solid var(--grid-line); background: rgba(0,0,0,0.4);
    cursor: pointer; transition: all 0.15s; min-width: 140px;
  }
  .char-card:hover { transform: translateY(-4px); }
  .char-card .avatar { width: 48px; height: 48px; image-rendering: pixelated; }
  .char-card .char-name { font-size: 9px; text-shadow: 0 0 6px currentColor; }
  .char-card .char-status { font-size: 7px; color: #555; margin-top: 2px; }
  .char-card .char-status.done { color: var(--neon-green); text-shadow: 0 0 4px var(--neon-green); }
  .char-card.has-picks { border-color: #333; }
  .char-card.has-picks .char-status { color: var(--neon-green); }

  /* MAIN LAYOUT */
  .main-layout { display: grid; grid-template-columns: 1fr 320px; gap: 16px; align-items: start; }

  /* CALENDAR PANEL */
  .cal-panel { min-width: 0; }
  .current-player-bar {
    display: flex; align-items: center; justify-content: center; gap: 10px;
    padding: 10px; margin-bottom: 12px;
    border: 3px solid var(--neon-green); background: rgba(57,255,20,0.05);
    box-shadow: 0 0 15px rgba(57,255,20,0.2);
    animation: borderGlow 2s ease-in-out infinite;
  }
  @keyframes borderGlow { 0%, 100% { box-shadow: 0 0 10px rgba(57,255,20,0.2); } 50% { box-shadow: 0 0 25px rgba(57,255,20,0.4); } }
  .current-player-bar .avatar { width: 28px; height: 28px; image-rendering: pixelated; }
  .current-player-bar span { font-size: 10px; }

  .month-nav { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 12px; }
  .month-nav button {
    font-family: 'Press Start 2P', monospace; font-size: 14px;
    background: transparent; border: 2px solid var(--neon-pink); color: var(--neon-pink);
    padding: 5px 12px; cursor: pointer; transition: all 0.15s;
  }
  .month-nav button:hover { background: var(--neon-pink); color: #000; box-shadow: 0 0 15px var(--neon-pink); }
  .month-label { font-size: 12px; color: var(--neon-cyan); text-shadow: 0 0 8px var(--neon-cyan); min-width: 220px; text-align: center; }

  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
  .day-header { text-align: center; font-size: 7px; color: var(--neon-purple); padding: 6px 2px; text-shadow: 0 0 5px var(--neon-purple); }
  .day-cell {
    aspect-ratio: 1; border: 2px solid var(--grid-line); background: rgba(0,0,0,0.3);
    display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    padding: 3px 2px; cursor: pointer; transition: all 0.1s; position: relative; min-height: 60px;
  }
  .day-cell:hover:not(.empty):not(.past) { border-color: var(--neon-cyan); box-shadow: 0 0 8px rgba(0,229,255,0.3); }
  .day-cell.empty { cursor: default; border-color: transparent; background: transparent; }
  .day-cell.past { opacity: 0.25; cursor: not-allowed; }
  .day-cell.today { border-color: var(--neon-yellow); box-shadow: 0 0 10px rgba(255,230,0,0.3); }
  .day-num { font-size: 8px; color: #aaa; margin-bottom: 2px; }
  .day-cell.today .day-num { color: var(--neon-yellow); text-shadow: 0 0 5px var(--neon-yellow); }
  .day-cell.selected-by-me { background: rgba(57,255,20,0.15); border-color: var(--neon-green); }
  .day-cell.perfect-match { border-color: var(--neon-yellow) !important; box-shadow: 0 0 15px rgba(255,230,0,0.5) !important; animation: perfectPulse 1s ease-in-out infinite; }
  @keyframes perfectPulse { 0%, 100% { box-shadow: 0 0 10px rgba(255,230,0,0.3); } 50% { box-shadow: 0 0 25px rgba(255,230,0,0.7); } }

  .availability-dots { display: flex; flex-wrap: wrap; gap: 2px; justify-content: center; margin-top: auto; }
  .avail-dot { width: 7px; height: 7px; }

  .match-badge { position: absolute; top: 1px; right: 2px; font-size: 6px; padding: 1px 2px; }
  .match-badge.full { color: var(--neon-yellow); text-shadow: 0 0 4px var(--neon-yellow); }
  .match-badge.partial { color: var(--neon-orange); }

  .cal-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 14px; }

  /* TALLY SIDEBAR */
  .tally-panel {
    border: 3px solid var(--neon-purple); background: rgba(0,0,0,0.7);
    padding: 14px; box-shadow: 0 0 10px rgba(176,38,255,0.3);
    position: sticky; top: 16px;
  }
  .tally-panel h3 { font-size: 10px; color: var(--neon-purple); text-shadow: 0 0 6px var(--neon-purple); margin-bottom: 12px; text-align: center; }
  .tally-player {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 6px; border-bottom: 1px solid var(--grid-line);
  }
  .tally-player:last-of-type { border-bottom: none; }
  .tally-player .avatar { width: 24px; height: 24px; image-rendering: pixelated; }
  .tally-player .tp-info { flex: 1; min-width: 0; }
  .tally-player .tp-name { font-size: 8px; margin-bottom: 3px; }
  .tally-player .tp-status { font-size: 7px; color: #555; }
  .tally-player .tp-status.picked { color: var(--neon-green); text-shadow: 0 0 4px var(--neon-green); }
  .tally-player .tp-count { font-size: 8px; color: var(--neon-cyan); min-width: 30px; text-align: right; }
  .tally-player.is-me { background: rgba(255,255,255,0.03); }

  .tally-divider { border: none; border-top: 2px dashed var(--grid-line); margin: 12px 0; }
  .tally-section-title { font-size: 9px; color: var(--neon-yellow); text-shadow: 0 0 6px var(--neon-yellow); margin-bottom: 10px; text-align: center; }

  .best-date-row {
    display: flex; align-items: center; gap: 6px;
    padding: 6px; margin-bottom: 6px;
    border: 2px solid;
  }
  .best-date-row.gold { border-color: var(--neon-yellow); box-shadow: 0 0 8px rgba(255,230,0,0.2); }
  .best-date-row.silver { border-color: #555; }
  .best-date-row .bd-date { font-size: 7px; flex: 1; }
  .best-date-row.gold .bd-date { color: var(--neon-yellow); }
  .best-date-row.silver .bd-date { color: #999; }
  .best-date-row .bd-dots { display: flex; gap: 2px; }
  .best-date-row .bd-dot { width: 8px; height: 8px; }
  .best-date-row .bd-count { font-size: 7px; color: var(--neon-green); min-width: 24px; text-align: right; }

  .no-matches { font-size: 7px; color: #444; text-align: center; padding: 10px; }

  /* BUTTONS */
  .btn {
    font-family: 'Press Start 2P', monospace; font-size: 9px;
    padding: 10px 16px; border: 3px solid; cursor: pointer;
    transition: all 0.15s; background: transparent; text-transform: uppercase;
  }
  .btn-save { border-color: var(--neon-green); color: var(--neon-green); }
  .btn-save:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 20px var(--neon-green); }
  .btn-reset { border-color: var(--neon-pink); color: var(--neon-pink); }
  .btn-reset:hover { background: var(--neon-pink); color: #000; box-shadow: 0 0 20px var(--neon-pink); }
  .btn-back { border-color: var(--neon-cyan); color: var(--neon-cyan); }
  .btn-back:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px var(--neon-cyan); }
  .btn-nuke { border-color: #666; color: #666; font-size: 7px; padding: 6px 10px; }
  .btn-nuke:hover { border-color: var(--neon-pink); color: var(--neon-pink); }

  .instructions { font-size: 7px; color: #555; text-align: center; margin-top: 8px; line-height: 1.8; }

  /* GRID FLOOR */
  .grid-floor {
    position: fixed; bottom: 0; left: 0; right: 0; height: 80px;
    background: linear-gradient(to bottom, transparent 0%, rgba(176,38,255,0.06) 100%),
      repeating-linear-gradient(90deg, var(--grid-line) 0px, var(--grid-line) 1px, transparent 1px, transparent 60px),
      repeating-linear-gradient(0deg, var(--grid-line) 0px, var(--grid-line) 1px, transparent 1px, transparent 30px);
    perspective: 200px; transform: rotateX(40deg); transform-origin: bottom;
    z-index: 0; pointer-events: none;
  }

  .phase { display: none; }
  .phase.active { display: block; }

  /* RESPONSIVE */
  @media (max-width: 850px) {
    .main-layout { grid-template-columns: 1fr; }
    .tally-panel { position: static; }
    .title-letter { font-size: 16px; }
    .pacman-container { width: 22px; height: 22px; }
    .pac-top, .pac-bottom { width: 22px; height: 11px; }
    .pac-top { border-radius: 11px 11px 0 0; }
    .pac-bottom { border-radius: 0 0 11px 11px; }
    .pac-eye { width: 4px; height: 4px; top: 2px; right: 4px; }
    .day-cell { min-height: 46px; }
  }
</style>
</head>
<body>

<div class="stars" id="stars"></div>
<div class="grid-floor"></div>

<div class="container">
  <div class="header">
    <div class="title-row" id="title-row">
      <div class="pac-dots" id="pac-dots"></div>
      <div class="pacman-container" id="pacman">
        <div class="pacman-body">
          <div class="pac-top"></div>
          <div class="pac-eye"></div>
          <div class="pac-bottom"></div>
        </div>
      </div>
      <span id="title-letters"></span>
    </div>
    <div class="subtitle">&#9658; FIND A NIGHT THAT WORKS FOR EVERYONE &#9668;</div>
  </div>

  <!-- PHASE 1: WHO ARE YOU? -->
  <div class="phase active" id="phase-select">
    <div class="pixel-box">
      <h2>&#9733; WHO ARE YOU? &#9733;</h2>
      <div class="char-select" id="char-select"></div>
      <p class="instructions">PICK YOUR CHARACTER TO SELECT YOUR AVAILABLE DATES</p>
      <div style="text-align:center; margin-top:18px;">
        <button class="btn btn-nuke" onclick="nukeAll()">RESET ALL DATA</button>
      </div>
    </div>
  </div>

  <!-- PHASE 2: CALENDAR + TALLY -->
  <div class="phase" id="phase-main">
    <div class="main-layout">
      <!-- LEFT: Calendar -->
      <div class="cal-panel">
        <div class="pixel-box" style="margin:0;">
          <div class="current-player-bar" id="current-player-bar"></div>
          <p class="instructions" style="margin-bottom:10px;">CLICK DATES YOU'RE FREE FOR DINNER</p>
          <div class="month-nav">
            <button onclick="changeMonth(-1)">&#9664;</button>
            <div class="month-label" id="month-label"></div>
            <button onclick="changeMonth(1)">&#9654;</button>
          </div>
          <div class="calendar-grid" id="calendar-grid"></div>
          <div class="cal-actions">
            <button class="btn btn-save" onclick="saveDates()">&#10003; SAVE MY DATES</button>
            <button class="btn btn-reset" onclick="clearMyDates()">CLEAR MINE</button>
            <button class="btn btn-back" onclick="goBack()">&#9664; BACK</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Tally -->
      <div class="tally-panel" id="tally-panel"></div>
    </div>
  </div>
</div>

<script>
// ── AUDIO ──
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function initAudio() { if (!audioCtx) audioCtx = new AudioCtx(); }
function playBeep(freq, dur, type='square') {
  try {
    initAudio();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq;
    g.gain.value = 0.07; g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + dur);
  } catch(e) {}
}
function sfxClick() { playBeep(660, 0.06); }
function sfxSelect() { playBeep(880, 0.07); setTimeout(() => playBeep(1100, 0.07), 40); }
function sfxSave() { [523,659,784,1047].forEach((f,i) => setTimeout(() => playBeep(f, 0.15), i*100)); }

// ── PIXEL AVATARS ──
const AVATAR_COLORS = ['#ff2d95','#00e5ff','#39ff14','#ffe600','#b026ff'];
const AVATAR_PATTERNS = [
  [0,0,1,1,1,1,0,0, 0,1,1,1,1,1,1,0, 1,1,0,1,1,0,1,1, 1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1, 1,0,1,1,1,1,0,1, 1,1,0,0,0,0,1,1, 0,1,1,1,1,1,1,0],
  [0,0,1,1,1,1,0,0, 0,1,1,1,1,1,1,0, 1,0,0,1,1,0,0,1, 1,1,1,1,1,1,1,1, 1,1,1,1,1,1,1,1, 1,1,0,0,0,0,1,1, 1,1,1,0,0,1,1,1, 0,1,1,1,1,1,1,0],
  [0,1,1,1,1,1,1,0, 1,1,1,1,1,1,1,1, 1,0,1,1,1,0,1,1, 1,1,1,1,1,1,1,1, 1,0,1,1,1,1,0,1, 1,1,0,0,0,0,1,1, 0,1,1,1,1,1,1,0, 0,0,1,1,1,1,0,0],
  [0,0,1,1,1,1,0,0, 0,1,1,1,1,1,1,0, 1,0,1,1,1,0,1,1, 1,1,1,1,1,0,1,1, 1,1,1,1,1,1,1,1, 1,0,1,1,1,1,0,1, 0,1,1,0,0,1,1,0, 0,0,1,1,1,1,0,0],
  [0,0,0,1,1,0,0,0, 0,0,1,1,1,1,0,0, 0,1,1,1,1,1,1,0, 1,0,1,1,1,0,1,1, 1,1,1,1,1,1,1,1, 1,1,0,0,0,0,1,1, 0,1,1,1,1,1,1,0, 0,0,1,1,1,1,0,0]
];

function makePixelAvatar(index) {
  const c = document.createElement('canvas');
  c.width = 8; c.height = 8;
  const ctx = c.getContext('2d');
  const p = AVATAR_PATTERNS[index];
  for (let y = 0; y < 8; y++)
    for (let x = 0; x < 8; x++)
      if (p[y*8+x]) { ctx.fillStyle = AVATAR_COLORS[index]; ctx.fillRect(x, y, 1, 1); }
  return c.toDataURL();
}

// ── PLAYERS ──
const PLAYER_NAMES = ['ADAM W', 'JASON S', 'JED E', 'DIANA P', 'BRIAN T'];
const STORAGE_KEY = 'dinnerquest86_data';

let players = []; // { name, color, avatar, selections: Set }
let activePlayerIndex = -1;
let viewYear, viewMonth;
const MONTHS = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
const DAYS = ['SUN','MON','TUE','WED','THU','FRI','SAT'];

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const data = JSON.parse(raw);
      return data; // { "ADAM W": ["2026-02-20",...], ... }
    }
  } catch(e) {}
  return {};
}

function saveData() {
  const data = {};
  players.forEach(p => { data[p.name] = [...p.selections]; });
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) {}
}

function initPlayers() {
  const saved = loadData();
  players = PLAYER_NAMES.map((name, i) => ({
    name,
    color: AVATAR_COLORS[i],
    avatar: makePixelAvatar(i),
    selections: new Set(saved[name] || [])
  }));
}

// ── STARS ──
function createStars() {
  const c = document.getElementById('stars');
  for (let i = 0; i < 80; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    s.style.left = Math.random()*100+'%';
    s.style.top = Math.random()*100+'%';
    s.style.animationDelay = Math.random()*3+'s';
    s.style.animationDuration = (1+Math.random()*2)+'s';
    c.appendChild(s);
  }
}

// ── CHARACTER SELECT ──
function renderCharSelect() {
  const container = document.getElementById('char-select');
  container.innerHTML = '';
  players.forEach((p, i) => {
    const hasPicks = p.selections.size > 0;
    const card = document.createElement('div');
    card.className = 'char-card' + (hasPicks ? ' has-picks' : '');
    card.style.borderColor = p.color;
    card.style.setProperty('--hover-color', p.color);
    card.innerHTML = `
      <img class="avatar" src="${p.avatar}">
      <div class="char-name" style="color:${p.color}">${p.name}</div>
      <div class="char-status ${hasPicks ? 'done' : ''}">${hasPicks ? '&#10003; ' + p.selections.size + ' DATES PICKED' : 'NO DATES YET'}</div>
    `;
    card.addEventListener('mouseenter', () => { card.style.borderColor = p.color; card.style.boxShadow = `0 0 20px ${p.color}60`; });
    card.addEventListener('mouseleave', () => { card.style.boxShadow = 'none'; if (!hasPicks) card.style.borderColor = p.color; });
    card.addEventListener('click', () => selectPlayer(i));
    container.appendChild(card);
  });
}

function selectPlayer(index) {
  sfxSelect();
  activePlayerIndex = index;
  showPhase('phase-main');
  renderPlayerBar();
  renderCalendar();
  renderTally();
}

// ── PHASES ──
function showPhase(id) {
  document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ── PLAYER BAR ──
function renderPlayerBar() {
  const p = players[activePlayerIndex];
  const bar = document.getElementById('current-player-bar');
  bar.style.borderColor = p.color;
  bar.style.boxShadow = `0 0 15px ${p.color}40`;
  bar.innerHTML = `
    <img class="avatar" src="${p.avatar}">
    <span style="font-size:10px; color:${p.color}; text-shadow:0 0 8px ${p.color};">${p.name} — PICK YOUR FREE DATES!</span>
  `;
}

// ── CALENDAR ──
function renderCalendar() {
  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';
  document.getElementById('month-label').textContent = `${MONTHS[viewMonth]} ${viewYear}`;

  DAYS.forEach(d => {
    const h = document.createElement('div');
    h.className = 'day-header'; h.textContent = d;
    grid.appendChild(h);
  });

  const firstDay = new Date(viewYear, viewMonth, 1).getDay();
  const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
  const today = new Date(); today.setHours(0,0,0,0);
  const me = players[activePlayerIndex];
  const totalPlayers = players.length;

  for (let i = 0; i < firstDay; i++) {
    const cell = document.createElement('div');
    cell.className = 'day-cell empty';
    grid.appendChild(cell);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const cell = document.createElement('div');
    const dateObj = new Date(viewYear, viewMonth, d);
    const dateStr = `${viewYear}-${String(viewMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isPast = dateObj < today;

    cell.className = 'day-cell';
    if (isPast) cell.classList.add('past');
    if (dateObj.getTime() === today.getTime()) cell.classList.add('today');
    if (me.selections.has(dateStr)) cell.classList.add('selected-by-me');

    // Count picks
    let count = 0;
    players.forEach(p => { if (p.selections.has(dateStr)) count++; });
    if (count === totalPlayers && count > 1) cell.classList.add('perfect-match');

    if (count > 1) {
      const badge = document.createElement('div');
      badge.className = 'match-badge ' + (count === totalPlayers ? 'full' : 'partial');
      badge.textContent = `${count}/${totalPlayers}`;
      cell.appendChild(badge);
    }

    const num = document.createElement('div');
    num.className = 'day-num'; num.textContent = d;
    cell.appendChild(num);

    const dots = document.createElement('div');
    dots.className = 'availability-dots';
    players.forEach(p => {
      if (p.selections.has(dateStr)) {
        const dot = document.createElement('div');
        dot.className = 'avail-dot';
        dot.style.background = p.color;
        dot.title = p.name;
        dots.appendChild(dot);
      }
    });
    cell.appendChild(dots);

    if (!isPast) {
      cell.addEventListener('click', () => {
        sfxClick();
        if (me.selections.has(dateStr)) me.selections.delete(dateStr);
        else me.selections.add(dateStr);
        renderCalendar();
        renderTally();
      });
    }

    grid.appendChild(cell);
  }
}

function changeMonth(delta) {
  sfxClick();
  viewMonth += delta;
  if (viewMonth > 11) { viewMonth = 0; viewYear++; }
  if (viewMonth < 0) { viewMonth = 11; viewYear--; }
  renderCalendar();
}

// ── TALLY SIDEBAR ──
function renderTally() {
  const panel = document.getElementById('tally-panel');
  let html = '<h3>&#9733; SQUAD STATUS &#9733;</h3>';

  // Player list
  players.forEach((p, i) => {
    const count = p.selections.size;
    const isMe = i === activePlayerIndex;
    html += `
      <div class="tally-player ${isMe ? 'is-me' : ''}">
        <img class="avatar" src="${p.avatar}">
        <div class="tp-info">
          <div class="tp-name" style="color:${p.color}">${p.name}${isMe ? ' (YOU)' : ''}</div>
          <div class="tp-status ${count > 0 ? 'picked' : ''}">${count > 0 ? '&#10003; DATES PICKED' : 'WAITING...'}</div>
        </div>
        <div class="tp-count">${count > 0 ? count : '-'}</div>
      </div>
    `;
  });

  // Best dates
  html += '<hr class="tally-divider"><div class="tally-section-title">&#9733; BEST DATES &#9733;</div>';

  const dateCounts = {};
  players.forEach(p => {
    p.selections.forEach(d => {
      if (!dateCounts[d]) dateCounts[d] = [];
      dateCounts[d].push(p);
    });
  });

  const sorted = Object.entries(dateCounts)
    .filter(([_, ppl]) => ppl.length >= 2)
    .sort((a, b) => {
      if (b[1].length !== a[1].length) return b[1].length - a[1].length;
      return a[0].localeCompare(b[0]);
    })
    .slice(0, 8);

  if (sorted.length === 0) {
    html += '<div class="no-matches">NO MATCHES YET...<br>KEEP PICKING!</div>';
  } else {
    sorted.forEach(([dateStr, ppl]) => {
      const d = new Date(dateStr + 'T12:00:00');
      const dayName = DAYS[d.getDay()];
      const monthName = MONTHS[d.getMonth()].slice(0,3);
      const isFull = ppl.length === players.length;
      html += `
        <div class="best-date-row ${isFull ? 'gold' : 'silver'}">
          <div class="bd-date">${dayName} ${monthName} ${d.getDate()}</div>
          <div class="bd-dots">${ppl.map(p => `<div class="bd-dot" style="background:${p.color}" title="${p.name}"></div>`).join('')}</div>
          <div class="bd-count">${ppl.length}/${players.length}</div>
        </div>
      `;
    });
  }

  panel.innerHTML = html;
}

// ── ACTIONS ──
function saveDates() {
  sfxSave();
  saveData();
  activePlayerIndex = -1;
  showPhase('phase-select');
  renderCharSelect();
}

function clearMyDates() {
  sfxClick();
  players[activePlayerIndex].selections.clear();
  renderCalendar();
  renderTally();
}

function goBack() {
  sfxClick();
  // Don't save — just go back
  initPlayers(); // reload from storage to discard unsaved changes
  activePlayerIndex = -1;
  showPhase('phase-select');
  renderCharSelect();
}

function nukeAll() {
  if (confirm('RESET ALL DATA? THIS CANNOT BE UNDONE!')) {
    sfxClick();
    try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
    initPlayers();
    renderCharSelect();
  }
}

// ── WAKA-WAKA SOUND ──
let wakaToggle = false;
function sfxWaka() {
  try {
    initAudio();
    const now = audioCtx.currentTime;
    // Alternating two-tone "waka" — low then high, toggling each call
    const freqA = wakaToggle ? 493 : 262; // B4 vs C4
    const freqB = wakaToggle ? 330 : 523; // E4 vs C5
    wakaToggle = !wakaToggle;

    // First chirp
    const o1 = audioCtx.createOscillator(), g1 = audioCtx.createGain();
    o1.type = 'square'; o1.frequency.value = freqA;
    g1.gain.setValueAtTime(0.09, now);
    g1.gain.exponentialRampToValueAtTime(0.001, now + 0.06);
    o1.connect(g1); g1.connect(audioCtx.destination);
    o1.start(now); o1.stop(now + 0.06);

    // Second chirp (the "ka")
    const o2 = audioCtx.createOscillator(), g2 = audioCtx.createGain();
    o2.type = 'square'; o2.frequency.value = freqB;
    g2.gain.setValueAtTime(0.07, now + 0.06);
    g2.gain.exponentialRampToValueAtTime(0.001, now + 0.12);
    o2.connect(g2); g2.connect(audioCtx.destination);
    o2.start(now + 0.06); o2.stop(now + 0.12);
  } catch(e) {}
}

// ── PAC-MAN TITLE ANIMATION ──
const TITLE_TEXT = "DINNER QUEST '86";
let pacAnimId = null;

function initTitle() {
  const container = document.getElementById('title-letters');
  container.innerHTML = '';
  TITLE_TEXT.split('').forEach((ch, i) => {
    const span = document.createElement('span');
    span.className = 'title-letter' + (ch === ' ' ? ' space' : '');
    span.textContent = ch === ' ' ? '\u00A0' : ch;
    span.dataset.index = i;
    container.appendChild(span);
  });
}

function startPacAnimation() {
  const titleRow = document.getElementById('title-row');
  const pacman = document.getElementById('pacman');
  const letters = document.querySelectorAll('.title-letter');
  const dotsContainer = document.getElementById('pac-dots');

  if (letters.length === 0) return;

  function buildDots() {
    const rr = titleRow.getBoundingClientRect();
    dotsContainer.innerHTML = '';
    letters.forEach((letter, i) => {
      if (letter.classList.contains('space')) return;
      const lRect = letter.getBoundingClientRect();
      const dot = document.createElement('div');
      dot.className = 'pac-dot';
      dot.style.left = (lRect.left - rr.left + lRect.width / 2 - 2) + 'px';
      dot.dataset.index = i;
      dotsContainer.appendChild(dot);
    });
  }

  const PAC_SIZE = 30;
  const SPEED = 2.5;
  let phase = 'eating'; // 'eating' | 'pause'
  let pacX = -40;
  let pauseTimer = 0;

  function getLetterCenters() {
    const rr = titleRow.getBoundingClientRect();
    return Array.from(letters).map(l => {
      const lr = l.getBoundingClientRect();
      return lr.left - rr.left + lr.width / 2;
    });
  }

  function resetLetters() {
    letters.forEach(l => l.classList.remove('eaten'));
  }

  function resetDots() {
    dotsContainer.querySelectorAll('.pac-dot').forEach(d => d.classList.remove('eaten'));
  }

  buildDots();
  let centers = getLetterCenters();
  let totalWidth = titleRow.offsetWidth;

  window.addEventListener('resize', () => {
    centers = getLetterCenters();
    totalWidth = titleRow.offsetWidth;
    buildDots();
  });

  function frame() {
    const pacCenter = pacX + PAC_SIZE / 2;

    if (phase === 'eating') {
      pacX += SPEED;
      pacman.style.left = pacX + 'px';

      // Eat letters as pacman passes them
      centers.forEach((cx, i) => {
        if (pacCenter >= cx && !letters[i].classList.contains('eaten')) {
          letters[i].classList.add('eaten');
          const dot = dotsContainer.querySelector(`.pac-dot[data-index="${i}"]`);
          if (dot) dot.classList.add('eaten');
          sfxWaka();
        }
      });

      // Once fully off the right edge
      if (pacX > totalWidth + 40) {
        phase = 'pause';
        pauseTimer = 70; // ~1.2s pause
        pacman.style.left = '-40px'; // hide off-screen left immediately
      }
    }
    else if (phase === 'pause') {
      pauseTimer--;
      // Restore letters partway through pause for a nice reappear
      if (pauseTimer === 40) {
        resetLetters();
        resetDots();
      }
      if (pauseTimer <= 0) {
        // Reset pacman to left, start eating again
        pacX = -40;
        pacman.style.left = pacX + 'px';
        phase = 'eating';
      }
    }

    pacAnimId = requestAnimationFrame(frame);
  }

  pacAnimId = requestAnimationFrame(frame);
}

// ── BOOT ──
function init() {
  createStars();
  const now = new Date();
  viewYear = now.getFullYear();
  viewMonth = now.getMonth();
  initPlayers();
  renderCharSelect();
  initTitle();
  // Start pac-man after a short delay to let fonts load
  setTimeout(startPacAnimation, 500);
}

init();
</script>
</body>
</html>
